import whisper
import os
import glob
import openai

# ğŸ“Œ Configuration
openai.api_key = os.getenv("OPENAI_API_KEY")  # Assure-toi que la clÃ© est bien dÃ©finie

# ğŸ” Rechercher tous les fichiers MP4 et MP3
audio_files = glob.glob("*.mp4") + glob.glob("*.mp3")

if not audio_files:
    print("âŒ Aucun fichier MP4 ou MP3 trouvÃ©.")
    exit()

# ğŸš€ Charger le modÃ¨le Whisper
model = whisper.load_model("tiny")

# ğŸ” Boucle sur chaque fichier audio
for audio_file in audio_files:
    print(f"ğŸµ Fichier trouvÃ© : {audio_file}")
    print("â³ Transcription en cours...")

    # ğŸ™ï¸ Transcription
    result = model.transcribe(audio_file)
    transcription = result["text"]

    # ğŸ“ Fichier de transcription
    transcript_filename = os.path.splitext(audio_file)[0] + "_transcription.txt"
    with open(transcript_filename, "w", encoding="utf-8") as f:
        f.write(transcription)
    print(f"âœ… Transcription enregistrÃ©e : {transcript_filename}")

    # ğŸ¤– Demande Ã  GPT-3.5 de faire un compte rendu
    print("ğŸ§  GÃ©nÃ©ration du compte rendu avec GPT-3.5-turbo...")

    try:
        response = openai.ChatCompletion.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": "Tu es un assistant qui rÃ©dige des comptes rendus professionnels."},
                {"role": "user", "content": f"Voici une transcription brute d'un audio. Peux-tu en faire un compte rendu clair et structurÃ© ?\n\n{transcription}"}
            ],
            temperature=0.7,
            max_tokens=1000
        )

        compte_rendu = response.choices[0].message.content

        # ğŸ’¾ Sauvegarde du compte rendu
        summary_filename = os.path.splitext(audio_file)[0] + "_compte_rendu.txt"
        with open(summary_filename, "w", encoding="utf-8") as f:
            f.write(compte_rendu)

        print(f"ğŸ“„ Compte rendu enregistrÃ© : {summary_filename}")

    except Exception as e:
        print(f"âŒ Erreur lors de la gÃ©nÃ©ration du compte rendu : {e}")
